<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ page.title }} | {{ site.title }}</title>
<link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">
<link rel="icon" href="{{ '/assets/images/favicon.png' | relative_url }}">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<!-- Noise overlay -->
<div class="noise-overlay"></div>

<!-- Digital grid (static, dense) -->
<div class="digital-grid"></div>

<!-- Grid highlight that follows cursor -->
<div class="grid-highlight"></div>

<!-- Boot Sequence - ONLY ON HOMEPAGE -->
{% if page.url == "/" %}
<div id="boot-sequence" class="boot">
<pre id="boot-text"></pre>
</div>
{% endif %}

<!-- Main Content -->
<div id="main-content" {% unless page.url == "/" %}style="display:block;"{% else %}style="display:none;"{% endunless %}>
<header>
<h1 class="title">{{ site.title }}</h1>
<p class="desc">{{ site.description }}</p>
{% unless page.url == "/" %}
<nav>
<a href="{{ '/' | relative_url }}" class="home-link">← Back to Lab</a>
</nav>
{% endunless %}
</header>
<main>
{{ content }}
</main>
</div>

<!-- Glowing Cursor -->
<div class="cursor-light"></div>

<!-- Scripts -->
<script>
// Grid highlight and cursor animation - runs on all pages
const cursor = document.querySelector(".cursor-light");
const gridHighlight = document.querySelector(".grid-highlight");
let x = 0, y = 0, targetX = 0, targetY = 0;

document.addEventListener("mousemove", e => {
  targetX = e.clientX;
  targetY = e.clientY;
  
  // Update grid highlight immediately
  if (gridHighlight) {
    gridHighlight.style.left = `${e.clientX}px`;
    gridHighlight.style.top = `${e.clientY}px`;
  }
});

function animateCursor() {
  x += (targetX - x) * 0.15;
  y += (targetY - y) * 0.15;
  if (cursor) {
    cursor.style.left = `${x}px`;
    cursor.style.top = `${y}px`;
  }
  requestAnimationFrame(animateCursor);
}
animateCursor();

{% if page.layout == "default" and page.url == "/" %}
(function() {
  const bootLines = [">Great to see you. I'm 0xm0t0k0 aka 0xth00rf1nn aka c1nn4m0nr0ls"];
  const bootText = document.getElementById("boot-text");
  const bootScreen = document.getElementById("boot-sequence");
  const mainContent = document.getElementById("main-content");
  
  if (!bootText || !bootScreen || !mainContent) return;
  
  let line = 0, char = 0;
  
  function typeBootLine() {
    if (line < bootLines.length) {
      if (char < bootLines[line].length) {
        bootText.textContent += bootLines[line].charAt(char);
        char++;
        setTimeout(typeBootLine, 30);
      } else {
        bootText.textContent += "\n";
        line++;
        char = 0;
        setTimeout(typeBootLine, 400);
      }
    } else {
      setTimeout(() => {
        bootScreen.style.opacity = "0";
        setTimeout(() => {
          bootScreen.style.display = "none";
          mainContent.style.display = "block";
        }, 1000);
      }, 600);
    }
  }
  
  typeBootLine();
})();
{% endif %}
</script>

<!-- Multi-Stage Encryption Puzzle Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const unlockBtn = document.getElementById('unlockBtn');
  const decryptInput = document.getElementById('decryptInput');
  const errorMessage = document.getElementById('errorMessage');
  const puzzle = document.getElementById('portfolioPuzzle');
  const content = document.getElementById('portfolioContent');
  const currentStageEl = document.getElementById('currentStage');
  const progressFill = document.getElementById('progressFill');
  
  if (!unlockBtn) return;
  
  // Stage configuration
  let currentStage = 1;
  const stages = {
    1: {
      answer: '0xm0t0k0',
      nextStage: 2,
      progress: 33
    },
    2: {
      answer: '0xth00rf1nn',
      nextStage: 3,
      progress: 66
    },
    3: {
      answer: '4cc3ss_gr4nt3d_w3lc0m3_!',
      nextStage: 'unlock',
      progress: 100
    }
  };
  

  
  // Check saved progress
  const savedStage = sessionStorage.getItem('puzzleStage');
  if (savedStage) {
    currentStage = parseInt(savedStage);
    loadStage(currentStage);
  }
  
  function loadStage(stageNum) {
    // Hide all stages
    for (let i = 1; i <= 3; i++) {
      const stage = document.getElementById(`stage${i}`);
      if (stage) stage.style.display = 'none';
    }
    
    // Show current stage
    const currentStageDiv = document.getElementById(`stage${stageNum}`);
    if (currentStageDiv) {
      currentStageDiv.style.display = 'block';
    }
    
    // Update UI
    currentStageEl.textContent = stageNum;
    decryptInput.value = '';
    decryptInput.focus();
    
    // Update progress bar
    const previousProgress = stageNum === 1 ? 0 : stages[stageNum - 1].progress;
    progressFill.style.width = previousProgress + '%';
  }
  
  function unlockPortfolio() {
    puzzle.style.display = 'none';
    content.style.display = 'block';
    sessionStorage.setItem('portfolioUnlocked', 'true');
    sessionStorage.removeItem('puzzleStage');
  }
  
  // Terminal typing effect for errors/success
  function typeMessage(element, message, color, callback) {
    element.style.color = color;
    element.textContent = '';
    let i = 0;
    const interval = setInterval(() => {
      if (i < message.length) {
        element.textContent += message.charAt(i);
        i++;
      } else {
        clearInterval(interval);
        if (callback) callback();
      }
    }, 30);
  }
  
  function checkAnswer() {
    const userAnswer = decryptInput.value.trim().toLowerCase();
    const correctAnswer = stages[currentStage].answer.toLowerCase();
    
    if (userAnswer === correctAnswer) {
      // Correct answer
      typeMessage(errorMessage, `✓ STAGE ${currentStage} COMPLETE - AUTHORIZATION GRANTED`, '#39ff14', () => {
        // Animate stage completion
        const stageDiv = document.getElementById(`stage${currentStage}`);
        if (stageDiv) {
          stageDiv.classList.add('stage-complete');
        }
        
        // Update progress
        progressFill.style.width = stages[currentStage].progress + '%';
        
        // Move to next stage or unlock
        setTimeout(() => {
          if (stages[currentStage].nextStage === 'unlock') {
            typeMessage(errorMessage, '✓ ALL STAGES COMPLETE - INITIATING ACCESS...', '#39ff14', () => {
              setTimeout(unlockPortfolio, 1000);
            });
          } else {
            currentStage = stages[currentStage].nextStage;
            sessionStorage.setItem('puzzleStage', currentStage);
            loadStage(currentStage);
            errorMessage.textContent = '';
          }
        }, 1500);
      });
      
    } else {
      // Wrong answer with terminal effect
      typeMessage(errorMessage, '✗ ACCESS DENIED - INVALID CREDENTIALS', '#ff3333');
      decryptInput.value = '';
      decryptInput.classList.add('error');
      
      // Glitch effect
      puzzle.style.animation = 'glitchShake 0.3s ease';
      setTimeout(() => {
        decryptInput.classList.remove('error');
        puzzle.style.animation = '';
        setTimeout(() => errorMessage.textContent = '', 2000);
      }, 500);
    }
  }
  
  unlockBtn.addEventListener('click', checkAnswer);
  
  decryptInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      checkAnswer();
    }
  });
  
  // Typing sound effect simulation (visual)
  decryptInput.addEventListener('input', () => {
    decryptInput.style.textShadow = '0 0 10px #39ff14';
    setTimeout(() => {
      decryptInput.style.textShadow = '0 0 5px #39ff14';
    }, 50);
  });
  
  // Optional hint system (click title 5 times)
  let hintClicks = 0;
  const puzzleTitle = document.querySelector('.puzzle-title');
  
  if (puzzleTitle) {
    puzzleTitle.addEventListener('click', () => {
      hintClicks++;
      if (hintClicks === 5) {
        const hints = {
          1: 'HINT: Binary to text converter required',
          2: 'HINT: Hexadecimal to ASCII decoder needed',
          3: 'HINT: Base64 decoder - final authentication key'
        };
        typeMessage(errorMessage, hints[currentStage], '#39ff14');
        setTimeout(() => {
          if (errorMessage.textContent.includes('HINT:')) {
            errorMessage.textContent = '';
          }
        }, 5000);
        hintClicks = 0;
      }
    });
  }
});
</script>

<!-- Portfolio Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const portfolioItems = document.querySelectorAll('.portfolio-item');
  const loadMoreBtn = document.getElementById('loadMore');
  const shownCountEl = document.getElementById('shownCount');
  const totalCountEl = document.getElementById('totalCount');
  const filterBtns = document.querySelectorAll('.filter-btn');
  
  if (!loadMoreBtn || !portfolioItems.length) return;
  
  let itemsPerLoad = 12;
  let currentItems = itemsPerLoad;
  
  totalCountEl.textContent = portfolioItems.length;
  
  function updateVisibility() {
    let visibleCount = 0;
    portfolioItems.forEach((item, index) => {
      if (!item.classList.contains('hidden-filter')) {
        if (visibleCount < currentItems) {
          item.classList.remove('hidden-load');
          item.style.animationDelay = `${(visibleCount % itemsPerLoad) * 0.05}s`;
          visibleCount++;
        } else {
          item.classList.add('hidden-load');
        }
      }
    });
    
    shownCountEl.textContent = visibleCount;
    
    const hiddenFilterCount = document.querySelectorAll('.hidden-filter').length;
    if (visibleCount >= portfolioItems.length - hiddenFilterCount) {
      loadMoreBtn.classList.add('hidden');
    } else {
      loadMoreBtn.classList.remove('hidden');
    }
  }
  
  updateVisibility();
  
  loadMoreBtn.addEventListener('click', () => {
    currentItems += itemsPerLoad;
    updateVisibility();
  });
  
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        observer.unobserve(img);
      }
    });
  });
  
  document.querySelectorAll('.portfolio-img.lazy').forEach(img => {
    imageObserver.observe(img);
  });
  
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const filter = btn.getAttribute('data-filter');
      currentItems = itemsPerLoad;
      
      portfolioItems.forEach(item => {
        if (filter === 'all' || item.getAttribute('data-category') === filter) {
          item.classList.remove('hidden-filter');
        } else {
          item.classList.add('hidden-filter');
        }
      });
      
      updateVisibility();
    });
  });
});
</script>

<!-- User Tracking & Persistence Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Generate or retrieve user ID
  function getUserId() {
    let userId = localStorage.getItem('cryptolab_user_id');
    if (!userId) {
      userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('cryptolab_user_id', userId);
    }
    return userId;
  }
  
  // Track puzzle completion with timestamp
  function trackPuzzleCompletion(userId) {
    const completions = JSON.parse(localStorage.getItem('puzzle_completions') || '[]');
    completions.push({
      userId: userId,
      timestamp: new Date().toISOString(),
      stages: [1, 2, 3]
    });
    localStorage.setItem('puzzle_completions', JSON.stringify(completions));
  }
  
  // Check if user completed puzzle recently (within 24 hours)
  function recentlyCompleted(userId) {
    const completions = JSON.parse(localStorage.getItem('puzzle_completions') || '[]');
    const userCompletions = completions.filter(c => c.userId === userId);
    
    if (userCompletions.length === 0) return false;
    
    const lastCompletion = new Date(userCompletions[userCompletions.length - 1].timestamp);
    const now = new Date();
    const hoursSince = (now - lastCompletion) / (1000 * 60 * 60);
    
    return hoursSince < 24;
  }
  
  // Show stats to returning users
  function showUserStats(userId) {
    const completions = JSON.parse(localStorage.getItem('puzzle_completions') || '[]');
    const userCompletions = completions.filter(c => c.userId === userId);
    
    if (userCompletions.length > 1) {
      const statsDiv = document.createElement('div');
      statsDiv.className = 'user-stats';
      statsDiv.innerHTML = `
        <p>Welcome back, ${userId.substr(0, 12)}...</p>
        <p>Puzzle completions: ${userCompletions.length}</p>
      `;
      document.querySelector('.encryption-puzzle')?.prepend(statsDiv);
    }
  }
  
  const userId = getUserId();
  
  // Modify unlock function to track completion
  const originalUnlockPortfolio = window.unlockPortfolio;
  if (typeof unlockPortfolio !== 'undefined') {
    window.unlockPortfolio = function() {
      trackPuzzleCompletion(userId);
      originalUnlockPortfolio();
    };
  }
  
  // Show stats on puzzle page
  if (document.getElementById('portfolioPuzzle')) {
    showUserStats(userId);
  }
  
  console.log(`[CryptoLab] User ID: ${userId}`);
  console.log(`[CryptoLab] Recent completion: ${recentlyCompleted(userId)}`);
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const navCmd = document.querySelector('.nav-cmd');
  if (navCmd) {
    const text = navCmd.textContent;
    navCmd.textContent = '';
    let i = 0;
    const typing = setInterval(() => {
      navCmd.textContent += text[i];
      i++;
      if (i === text.length) {
        clearInterval(typing);
        // Fade in output after typing
        document.querySelector('.cmd-output').style.animation = 'fadeIn 0.5s ease';
      }
    }, 120);
  }
});
</script>

</body>
</html>